<style>
#playground-inputs {
  display: block;
  width: 100%;
  min-height: 15em;
  margin-top: 2px;
  padding: .7720588235em 1.1764705882em;
  outline: none;
  color: var(--md-code-fg-color);
  background-color: var(--md-code-bg-color);
  font-feature-settings: "kern";
  font-family: var(--md-code-font-family,_),SFMono-Regular,Consolas,Menlo,monospace;
  line-height: 1.4;
  font-size: .85em;
}

#playground-results code {
  height: 15em;
}

#playground-results pre {
  margin-bottom: 0;
}

#playground-results .swatch-bar {
  min-height: calc(3em + 4px);
}
</style>

<script type="text/javascript">
// set the Pyodide files URL (packages.json, pyodide.asm.data etc)
window.languagePluginUrl = 'https://cdn.jsdelivr.net/pyodide/v0.17.0a2/full/';
</script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.17.0a2/full/pyodide.js"></script>

<script type="text/javascript">
const inputs = document.getElementById("playground-inputs");
const results = document.getElementById("playground-results");
let busy = false;
let requests = 0;

function pyexecute(str) {
    code = `
import micropip
from js import document

results = document.getElementById("playground-results")

--8<-- "pycode.txt"

text = """
${str.replace('"', '\\"')}
"""

def parse_colors(*args):
    """Get colors."""

    # Store results in global "results"
    html = color_command_formatter(text)
    results.innerHTML = color_command_formatter(text)
    scrollingElement = results.querySelector('code')
    scrollingElement.scrollTop = scrollingElement.scrollHeight

micropip.install('coloraide').add_done_callback(parse_colors)
`

    languagePluginLoader.then(() => {
      return pyodide.loadPackage(['micropip', 'Pygments']);
    }).then(() => {
      pyodide.runPython(code);
      busy = false;
      if (requests) {
        setTimeout(payload, 100);
      }
    });
}

inputs.addEventListener("input", (e) => {
  requests++;
  payload();
});

function payload () {
  // Throttle requests

  if (busy) {
    return;
  }

  // Execute
  if (requests) {
    requests = 0;
    busy = true;
    pyexecute(inputs.value);
  }
};

// Initial first run after load.
inputs.focus();
busy = true;
pyexecute(inputs.value);
</script>
